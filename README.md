# Telegram Реферальный Бот

Полностью рабочий Telegram-бот на Go для управления реферальной системой с интеграцией Google Sheets.

## Возможности

- ✅ Регистрация рефоводов с уникальными кодами
- ✅ Генерация реферальных ссылок
- ✅ Отслеживание рефералов и статистика
- ✅ Подключение TON-кошельков
- ✅ Автоматическая синхронизация с Google Sheets
- ✅ Начисление бонусов (10% от прибыли рефералов)
- ✅ Обработка ошибок и восстановление после паник

## Требования

- Go 1.22 или выше
- Telegram Bot Token (получить у [@BotFather](https://t.me/BotFather))
- Google Service Account с доступом к Google Sheets API
- Google Таблица с правильной структурой листов

## Установка

1. Клонируйте репозиторий или скопируйте файлы проекта

2. Установите зависимости:
```bash
go mod download
```

3. Создайте файл `.env` на основе `.env.example`:
```bash
cp .env.example .env
```

4. Заполните `.env` файл:
   - `TELEGRAM_BOT_TOKEN` - токен вашего бота от BotFather
   - `SPREADSHEET_ID` - ID вашей Google Таблицы
   - `GOOGLE_CREDENTIALS_PATH` - путь к файлу credentials.json (по умолчанию `credentials.json`)
   - `SYNC_INTERVAL_HOURS` - интервал синхронизации в часах (по умолчанию 2)

5. Настройте Google Service Account:
   - Перейдите в [Google Cloud Console](https://console.cloud.google.com/)
   - Создайте новый проект или выберите существующий
   - Включите Google Sheets API
   - Создайте Service Account
   - Скачайте JSON-ключ и сохраните как `credentials.json` в корне проекта
   - Поделитесь вашей Google Таблицей с email из Service Account (дайте права редактора)

6. Подготовьте Google Таблицу:

   Создайте таблицу со следующими листами:

   **Лист "Рефоводы"** (заголовки в первой строке):
   - A: ID (int64)
   - B: Username (string с @)
   - C: Код (6 символов A-Z0-9)
   - D: Кошелёк TON (string или пусто)
   - E: Количество рефералов (int)
   - F: Ожидает выплаты (float64, USDT)

   **Лист "Приглашенные"** (заголовки в первой строке):
   - A: ID пользователя (int64)
   - B: Код пригласившего (string)

   **Лист "Рефералы"** (заголовки в первой строке):
   - A: ID реферала (int64)
   - B: Код пригласившего (string)
   - C: Чистая прибыль реферала (float64)
   - D: ID сделки (string)
   - E: Бонус рефоводу (float64, 10% от прибыли)
   - F: Дата начисления (string, формат 02.01.2006 15:04)

   **Лист "Выводы"** (заголовки в первой строке, только чтение):
   - A: ID сделки (string)
   - B: ID пользователя (int64) ← это id реферала
   - D: Прибыль (float64, USDT)

## Запуск

```bash
go run .
```

Бот запустится и начнет обрабатывать команды. Фоновая синхронизация будет выполняться каждые 2 часа (или согласно настройке `SYNC_INTERVAL_HOURS`).

## Команды бота

- `/start` - регистрация/приветствие
- `/start REFXXX` - привязка к реферальному коду

## Кнопки меню

- **Пригласить друзей** - генерирует и показывает реферальную ссылку
- **Мои рефералы** - показывает статистику (количество рефералов, ожидающие выплаты, кошелёк)
- **Подключить TON-кошелёк** - запрашивает и сохраняет адрес TON-кошелька

## Логика работы

1. **Регистрация рефовода**: При первом `/start` создается запись в листе "Рефоводы" с уникальным 6-символьным кодом

2. **Реферальная ссылка**: Генерируется ссылка вида `https://t.me/BOT_USERNAME?start=КОД`

3. **Привязка реферала**: При переходе по ссылке `/start КОД`:
   - Создается запись в "Приглашенные"
   - Увеличивается счетчик рефералов у рефовода

4. **Синхронизация**: Каждые 2 часа (или по настройке):
   - Сканируется лист "Выводы" на новые сделки
   - Для каждой новой сделки:
     - Находится реферал в "Приглашенные"
     - Получается код пригласившего
     - Считается бонус (10% от прибыли)
     - Создается запись в "Рефералы"
     - Добавляется бонус к "Ожидает выплаты" у рефовода

## Структура проекта

```
ss_ref_bot/
├── main.go              # Точка входа
├── config/
│   └── config.go        # Конфигурация из .env
├── bot/
│   └── bot.go           # Логика Telegram-бота
├── sheets/
│   └── sheets.go        # Работа с Google Sheets API
├── go.mod               # Зависимости
├── .env.example         # Пример конфигурации
├── README.md            # Документация
└── credentials.json     # Google Service Account ключ (не в git!)
```

## Безопасность

- ⚠️ **НЕ коммитьте** файл `credentials.json` в git
- ⚠️ **НЕ коммитьте** файл `.env` в git
- Добавьте в `.gitignore`:
  ```
  .env
  credentials.json
  ```

## Обработка ошибок

- Все ошибки логируются на русском языке
- Паники в горутинах обрабатываются через `recover()`
- Бот продолжает работу даже при ошибках синхронизации
- Идемпотентность: повторные запуски не создают дубликаты

## Разработка

Проект написан с учетом лучших практик Go:
- Модульная структура
- Обработка всех ошибок
- Защита от паник
- Понятный и читаемый код
- Готов к дальнейшему развитию

## Лицензия

MIT
